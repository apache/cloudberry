-- start_ignore
select sess_id from pg_stat_activity where pg_backend_pid()=pid;
 sess_id 
---------
      26
(1 row)

\gset
-- end_ignore
CREATE TABLE foo(a int);
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'a' as the Cloudberry Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE TABLE test(a int);
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'a' as the Cloudberry Database data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
INSERT INTO foo SELECT generate_series(0,10);
INSERT INTO test SELECT generate_series(0,10);
select count(*) from foo,test where foo.a=test.a;
 count 
-------
    11
(1 row)

-- test nested query
create or replace function n_join_foo_test() returns integer as $$
begin
	return (select count(*) from foo join test on foo.a=test.a);
end;
$$ language plpgsql;
select * from n_join_foo_test();
 n_join_foo_test 
-----------------
              11
(1 row)

DROP TABLE foo;
DROP TABLE test;
\c gpperfmon
-- start_ignore
select pg_sleep(100);
 pg_sleep 
----------
 
(1 row)

analyze system_history;
analyze database_history;
analyze diskspace_history;
analyze queries_history;
-- end_ignore
select count(*) > 0 from system_now;
 ?column? 
----------
 t
(1 row)

select count(*) > 0 from database_now;
 ?column? 
----------
 t
(1 row)

select count(*) > 0 from diskspace_now;
 ?column? 
----------
 t
(1 row)

select count(*) > 0 from system_history;
 ?column? 
----------
 t
(1 row)

select count(*) > 0 from database_history;
 ?column? 
----------
 t
(1 row)

select count(*) > 0 from diskspace_history;
 ?column? 
----------
 t
(1 row)

select ccnt, status, query_text, length(query_plan) > 0 from queries_history
where ssid = :sess_id order by ccnt;
 ccnt | status |                            query_text                            | ?column? 
------+--------+------------------------------------------------------------------+----------
    2 | done   | select sess_id from pg_stat_activity where pg_backend_pid()=pid; | t
    4 | done   | select sess_id from pg_stat_activity where pg_backend_pid()=pid; | t
    8 | done   | INSERT INTO foo SELECT generate_series(0,10);                    | t
   10 | done   | INSERT INTO test SELECT generate_series(0,10);                   | t
   12 | done   | select count(*) from foo,test where foo.a=test.a;                | t
   15 | done   | select * from n_join_foo_test();                                 | t
(6 rows)

SELECT COUNT(*) FROM (SELECT DISTINCT ccnt FROM queries_history
where ssid = :sess_id) as temp;
 count 
-------
     6
(1 row)

