-- @Description Ensures that a select after a vacuum operation is ok
--
DROP TABLE IF EXISTS pax_tbl;
DROP
DROP TABLE IF EXISTS pax_tbl2;
DROP
CREATE TABLE pax_tbl2 (a INT);
CREATE
CREATE TABLE pax_tbl (a INT);
CREATE
insert into pax_tbl select generate_series(1,1000);
INSERT 1000
insert into pax_tbl select generate_series(1,1000);
INSERT 1000
insert into pax_tbl select generate_series(1,1000);
INSERT 1000
insert into pax_tbl select generate_series(1,1000);
INSERT 1000
insert into pax_tbl select generate_series(1,1000);
INSERT 1000
insert into pax_tbl select generate_series(1,1000);
INSERT 1000
insert into pax_tbl select generate_series(1,1000);
INSERT 1000
insert into pax_tbl select generate_series(1,1000);
INSERT 1000
insert into pax_tbl select generate_series(1,1000);
INSERT 1000
insert into pax_tbl select generate_series(1,1000);
INSERT 1000
insert into pax_tbl select generate_series(1,1000);
INSERT 1000
insert into pax_tbl select generate_series(1,1000);
INSERT 1000
insert into pax_tbl select generate_series(1,1000);
INSERT 1000
insert into pax_tbl select generate_series(1,1000);
INSERT 1000
insert into pax_tbl select generate_series(1,1000);
INSERT 1000
insert into pax_tbl select generate_series(1,1000);
INSERT 1000
insert into pax_tbl select generate_series(1,1000);
INSERT 1000
insert into pax_tbl select generate_series(1,1000);
INSERT 1000
insert into pax_tbl select generate_series(1,1000);
INSERT 1000
insert into pax_tbl select generate_series(1,1000);
INSERT 1000
insert into pax_tbl select generate_series(1,1000);
INSERT 1000
insert into pax_tbl2 select generate_series(1,1000);
INSERT 1000

-- The actual test begins
DELETE FROM pax_tbl WHERE a < 128;
DELETE 2667
1: BEGIN;
BEGIN
1: SELECT COUNT(*) FROM pax_tbl2;
 count 
-------
 1000  
(1 row)
0: SELECT ptblockname, case when pttupcount = 0 then 'zero' when pttupcount = 1 then 'one' when pttupcount <= 5 then 'few' else 'many' end FROM get_pax_aux_table_all('pax_tbl');
 ptblockname | case 
-------------+------
 0           | many 
 1           | many 
 2           | many 
 3           | many 
 4           | many 
 5           | many 
 6           | many 
 7           | many 
 8           | many 
 9           | many 
 10          | many 
 11          | many 
 12          | many 
 13          | many 
 14          | many 
 15          | many 
 16          | many 
 17          | many 
 18          | many 
 19          | many 
 20          | many 
 0           | many 
 1           | many 
 2           | many 
 3           | many 
 4           | many 
 5           | many 
 6           | many 
 7           | many 
 8           | many 
 9           | many 
 10          | many 
 11          | many 
 12          | many 
 13          | many 
 14          | many 
 15          | many 
 16          | many 
 17          | many 
 18          | many 
 19          | many 
 20          | many 
 0           | many 
 1           | many 
 2           | many 
 3           | many 
 4           | many 
 5           | many 
 6           | many 
 7           | many 
 8           | many 
 9           | many 
 10          | many 
 11          | many 
 12          | many 
 13          | many 
 14          | many 
 15          | many 
 16          | many 
 17          | many 
 18          | many 
 19          | many 
 20          | many 
(63 rows)
2: VACUUM pax_tbl;
VACUUM
1: SELECT COUNT(*) FROM pax_tbl;
 count 
-------
 18333 
(1 row)
1: COMMIT;
COMMIT
1: SELECT COUNT(*) FROM pax_tbl;
 count 
-------
 18333 
(1 row)
3: INSERT INTO pax_tbl VALUES (0);
INSERT 1
0: SELECT ptblockname, case when pttupcount = 0 then 'zero' when pttupcount = 1 then 'one' when pttupcount <= 5 then 'few' else 'many' end FROM get_pax_aux_table_all('pax_tbl');
 ptblockname | case 
-------------+------
 21          | many 
 21          | many 
 21          | many 
 22          | one  
(4 rows)
0: SELECT * FROM get_pax_aux_table_all('pax_tbl');
 segment_id | ptblockname | pttupcount | ptstatistics                     | ptexistvisimap | ptexistexttoast | ptisclustered 
------------+-------------+------------+----------------------------------+----------------+-----------------+---------------
 0          | 21          | 6069       | [(false,false),(6069),None,None] | f              | f               | f             
 1          | 21          | 5922       | [(false,false),(5922),None,None] | f              | f               | f             
 1          | 22          | 1          | [(false,false),(1),None,None]    | f              | f               | f             
 2          | 21          | 6342       | [(false,false),(6342),None,None] | f              | f               | f             
(4 rows)
