CREATE EXTENSION yagp_hooks_collector;
CREATE OR REPLACE FUNCTION yagp_status_order(status text)
RETURNS integer
AS $$
BEGIN
    RETURN CASE status
        WHEN 'QUERY_STATUS_SUBMIT' THEN 1
        WHEN 'QUERY_STATUS_START' THEN 2
        WHEN 'QUERY_STATUS_END' THEN 3
        WHEN 'QUERY_STATUS_DONE' THEN 4
        ELSE 999
    END;
END;
$$ LANGUAGE plpgsql IMMUTABLE;
SET yagpcc.enable TO TRUE;
SET yagpcc.report_nested_queries TO TRUE;
SET yagpcc.enable_utility TO FALSE;
-- Basic SELECT tests
SET yagpcc.logging_mode to 'TBL';
SELECT 1;
 ?column? 
----------
        1
(1 row)

SELECT COUNT(*) FROM generate_series(1,10);
 count 
-------
    10
(1 row)

RESET yagpcc.logging_mode;
SELECT segid, query_text, query_status FROM yagpcc.log ORDER BY segid, ccnt, yagp_status_order(query_status) ASC;
 segid |                 query_text                  |    query_status     
-------+---------------------------------------------+---------------------
    -1 | SELECT 1;                                   | QUERY_STATUS_SUBMIT
    -1 | SELECT 1;                                   | QUERY_STATUS_START
    -1 | SELECT 1;                                   | QUERY_STATUS_END
    -1 | SELECT 1;                                   | QUERY_STATUS_DONE
    -1 | SELECT COUNT(*) FROM generate_series(1,10); | QUERY_STATUS_SUBMIT
    -1 | SELECT COUNT(*) FROM generate_series(1,10); | QUERY_STATUS_START
    -1 | SELECT COUNT(*) FROM generate_series(1,10); | QUERY_STATUS_END
    -1 | SELECT COUNT(*) FROM generate_series(1,10); | QUERY_STATUS_DONE
(8 rows)

SELECT yagpcc.truncate_log() IS NOT NULL AS t;
 t 
---
 t
(1 row)

-- Transaction test
SET yagpcc.logging_mode to 'TBL';
BEGIN;
SELECT 1;
 ?column? 
----------
        1
(1 row)

COMMIT;
RESET yagpcc.logging_mode;
SELECT segid, query_text, query_status FROM yagpcc.log ORDER BY segid, ccnt, yagp_status_order(query_status) ASC;
 segid | query_text |    query_status     
-------+------------+---------------------
    -1 | SELECT 1;  | QUERY_STATUS_SUBMIT
    -1 | SELECT 1;  | QUERY_STATUS_START
    -1 | SELECT 1;  | QUERY_STATUS_END
    -1 | SELECT 1;  | QUERY_STATUS_DONE
(4 rows)

SELECT yagpcc.truncate_log() IS NOT NULL AS t;
 t 
---
 t
(1 row)

-- CTE test
SET yagpcc.logging_mode to 'TBL';
WITH t AS (VALUES (1), (2))
SELECT * FROM t;
 column1 
---------
       1
       2
(2 rows)

RESET yagpcc.logging_mode;
SELECT segid, query_text, query_status FROM yagpcc.log ORDER BY segid, ccnt, yagp_status_order(query_status) ASC;
 segid |         query_text          |    query_status     
-------+-----------------------------+---------------------
    -1 | WITH t AS (VALUES (1), (2))+| QUERY_STATUS_SUBMIT
       | SELECT * FROM t;            | 
    -1 | WITH t AS (VALUES (1), (2))+| QUERY_STATUS_START
       | SELECT * FROM t;            | 
    -1 | WITH t AS (VALUES (1), (2))+| QUERY_STATUS_END
       | SELECT * FROM t;            | 
    -1 | WITH t AS (VALUES (1), (2))+| QUERY_STATUS_DONE
       | SELECT * FROM t;            | 
(4 rows)

SELECT yagpcc.truncate_log() IS NOT NULL AS t;
 t 
---
 t
(1 row)

-- Prepared statement test
SET yagpcc.logging_mode to 'TBL';
PREPARE test_stmt AS SELECT 1;
EXECUTE test_stmt;
 ?column? 
----------
        1
(1 row)

DEALLOCATE test_stmt;
RESET yagpcc.logging_mode;
SELECT segid, query_text, query_status FROM yagpcc.log ORDER BY segid, ccnt, yagp_status_order(query_status) ASC;
 segid |           query_text           |    query_status     
-------+--------------------------------+---------------------
    -1 | PREPARE test_stmt AS SELECT 1; | QUERY_STATUS_SUBMIT
    -1 | PREPARE test_stmt AS SELECT 1; | QUERY_STATUS_START
    -1 | PREPARE test_stmt AS SELECT 1; | QUERY_STATUS_END
    -1 | PREPARE test_stmt AS SELECT 1; | QUERY_STATUS_DONE
(4 rows)

SELECT yagpcc.truncate_log() IS NOT NULL AS t;
 t 
---
 t
(1 row)

DROP FUNCTION yagp_status_order(text);
DROP EXTENSION yagp_hooks_collector;
RESET yagpcc.enable;
RESET yagpcc.report_nested_queries;
RESET yagpcc.enable_utility;
