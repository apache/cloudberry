CREATE EXTENSION yagp_hooks_collector;
CREATE FUNCTION yagp_status_order(status text)
RETURNS integer
AS $$
BEGIN
    RETURN CASE status
        WHEN 'QUERY_STATUS_SUBMIT' THEN 1
        WHEN 'QUERY_STATUS_START' THEN 2
        WHEN 'QUERY_STATUS_END' THEN 3
        WHEN 'QUERY_STATUS_DONE' THEN 4
        ELSE 999
    END;
END;
$$ LANGUAGE plpgsql IMMUTABLE;
SET yagpcc.enable TO TRUE;
SET yagpcc.enable_utility TO TRUE;
SET yagpcc.report_nested_queries TO TRUE;
-- DECLARE
SET yagpcc.logging_mode to 'TBL';
BEGIN;
DECLARE cursor_stats_0 CURSOR FOR SELECT 0;
CLOSE cursor_stats_0;
COMMIT;
RESET yagpcc.logging_mode;
SELECT segid, query_text, query_status FROM yagpcc.log WHERE segid = -1 AND utility = true ORDER BY segid, ccnt, yagp_status_order(query_status) ASC;
 segid |                 query_text                  |    query_status     
-------+---------------------------------------------+---------------------
    -1 |                                             | QUERY_STATUS_DONE
    -1 | BEGIN;                                      | QUERY_STATUS_SUBMIT
    -1 | BEGIN;                                      | QUERY_STATUS_DONE
    -1 | DECLARE cursor_stats_0 CURSOR FOR SELECT 0; | QUERY_STATUS_SUBMIT
    -1 | DECLARE cursor_stats_0 CURSOR FOR SELECT 0; | QUERY_STATUS_DONE
    -1 | CLOSE cursor_stats_0;                       | QUERY_STATUS_SUBMIT
    -1 | CLOSE cursor_stats_0;                       | QUERY_STATUS_DONE
    -1 | COMMIT;                                     | QUERY_STATUS_SUBMIT
    -1 | COMMIT;                                     | QUERY_STATUS_DONE
    -1 | RESET yagpcc.logging_mode;                  | QUERY_STATUS_SUBMIT
(10 rows)

SELECT yagpcc.truncate_log() IS NOT NULL AS t;
 t 
---
 t
(1 row)

-- DECLARE WITH HOLD
SET yagpcc.logging_mode to 'TBL';
BEGIN;
DECLARE cursor_stats_1 CURSOR WITH HOLD FOR SELECT 1;
CLOSE cursor_stats_1;
DECLARE cursor_stats_2 CURSOR WITH HOLD FOR SELECT 2;
CLOSE cursor_stats_2;
COMMIT;
RESET yagpcc.logging_mode;
SELECT segid, query_text, query_status FROM yagpcc.log WHERE segid = -1 AND utility = true ORDER BY segid, ccnt, yagp_status_order(query_status) ASC;
 segid |                      query_text                       |    query_status     
-------+-------------------------------------------------------+---------------------
    -1 |                                                       | QUERY_STATUS_DONE
    -1 | BEGIN;                                                | QUERY_STATUS_SUBMIT
    -1 | BEGIN;                                                | QUERY_STATUS_DONE
    -1 | DECLARE cursor_stats_1 CURSOR WITH HOLD FOR SELECT 1; | QUERY_STATUS_SUBMIT
    -1 | DECLARE cursor_stats_1 CURSOR WITH HOLD FOR SELECT 1; | QUERY_STATUS_DONE
    -1 | CLOSE cursor_stats_1;                                 | QUERY_STATUS_SUBMIT
    -1 | CLOSE cursor_stats_1;                                 | QUERY_STATUS_DONE
    -1 | DECLARE cursor_stats_2 CURSOR WITH HOLD FOR SELECT 2; | QUERY_STATUS_SUBMIT
    -1 | DECLARE cursor_stats_2 CURSOR WITH HOLD FOR SELECT 2; | QUERY_STATUS_DONE
    -1 | CLOSE cursor_stats_2;                                 | QUERY_STATUS_SUBMIT
    -1 | CLOSE cursor_stats_2;                                 | QUERY_STATUS_DONE
    -1 | COMMIT;                                               | QUERY_STATUS_SUBMIT
    -1 | COMMIT;                                               | QUERY_STATUS_DONE
    -1 | RESET yagpcc.logging_mode;                            | QUERY_STATUS_SUBMIT
(14 rows)

SELECT yagpcc.truncate_log() IS NOT NULL AS t;
 t 
---
 t
(1 row)

-- ROLLBACK
SET yagpcc.logging_mode to 'TBL';
BEGIN;
DECLARE cursor_stats_3 CURSOR FOR SELECT 1;
CLOSE cursor_stats_3;
DECLARE cursor_stats_4 CURSOR FOR SELECT 1;
ROLLBACK;
RESET yagpcc.logging_mode;
SELECT segid, query_text, query_status FROM yagpcc.log WHERE segid = -1 AND utility = true ORDER BY segid, ccnt, yagp_status_order(query_status) ASC;
 segid |                 query_text                  |    query_status     
-------+---------------------------------------------+---------------------
    -1 |                                             | QUERY_STATUS_DONE
    -1 | BEGIN;                                      | QUERY_STATUS_SUBMIT
    -1 | BEGIN;                                      | QUERY_STATUS_DONE
    -1 | DECLARE cursor_stats_3 CURSOR FOR SELECT 1; | QUERY_STATUS_SUBMIT
    -1 | DECLARE cursor_stats_3 CURSOR FOR SELECT 1; | QUERY_STATUS_DONE
    -1 | CLOSE cursor_stats_3;                       | QUERY_STATUS_SUBMIT
    -1 | CLOSE cursor_stats_3;                       | QUERY_STATUS_DONE
    -1 | DECLARE cursor_stats_4 CURSOR FOR SELECT 1; | QUERY_STATUS_SUBMIT
    -1 | DECLARE cursor_stats_4 CURSOR FOR SELECT 1; | QUERY_STATUS_DONE
    -1 | ROLLBACK;                                   | QUERY_STATUS_SUBMIT
    -1 | ROLLBACK;                                   | QUERY_STATUS_DONE
    -1 | RESET yagpcc.logging_mode;                  | QUERY_STATUS_SUBMIT
(12 rows)

SELECT yagpcc.truncate_log() IS NOT NULL AS t;
 t 
---
 t
(1 row)

-- FETCH
SET yagpcc.logging_mode to 'TBL';
BEGIN;
DECLARE cursor_stats_5 CURSOR WITH HOLD FOR SELECT 2;
DECLARE cursor_stats_6 CURSOR WITH HOLD FOR SELECT 3;
FETCH 1 IN cursor_stats_5;
 ?column? 
----------
        2
(1 row)

FETCH 1 IN cursor_stats_6;
 ?column? 
----------
        3
(1 row)

CLOSE cursor_stats_5;
CLOSE cursor_stats_6;
COMMIT;
RESET yagpcc.logging_mode;
SELECT segid, query_text, query_status FROM yagpcc.log WHERE segid = -1 AND utility = true ORDER BY segid, ccnt, yagp_status_order(query_status) ASC;
 segid |                      query_text                       |    query_status     
-------+-------------------------------------------------------+---------------------
    -1 |                                                       | QUERY_STATUS_DONE
    -1 | BEGIN;                                                | QUERY_STATUS_SUBMIT
    -1 | BEGIN;                                                | QUERY_STATUS_DONE
    -1 | DECLARE cursor_stats_5 CURSOR WITH HOLD FOR SELECT 2; | QUERY_STATUS_SUBMIT
    -1 | DECLARE cursor_stats_5 CURSOR WITH HOLD FOR SELECT 2; | QUERY_STATUS_DONE
    -1 | DECLARE cursor_stats_6 CURSOR WITH HOLD FOR SELECT 3; | QUERY_STATUS_SUBMIT
    -1 | DECLARE cursor_stats_6 CURSOR WITH HOLD FOR SELECT 3; | QUERY_STATUS_DONE
    -1 | FETCH 1 IN cursor_stats_5;                            | QUERY_STATUS_SUBMIT
    -1 | FETCH 1 IN cursor_stats_5;                            | QUERY_STATUS_DONE
    -1 | FETCH 1 IN cursor_stats_6;                            | QUERY_STATUS_SUBMIT
    -1 | FETCH 1 IN cursor_stats_6;                            | QUERY_STATUS_DONE
    -1 | CLOSE cursor_stats_5;                                 | QUERY_STATUS_SUBMIT
    -1 | CLOSE cursor_stats_5;                                 | QUERY_STATUS_DONE
    -1 | CLOSE cursor_stats_6;                                 | QUERY_STATUS_SUBMIT
    -1 | CLOSE cursor_stats_6;                                 | QUERY_STATUS_DONE
    -1 | COMMIT;                                               | QUERY_STATUS_SUBMIT
    -1 | COMMIT;                                               | QUERY_STATUS_DONE
    -1 | RESET yagpcc.logging_mode;                            | QUERY_STATUS_SUBMIT
(18 rows)

SELECT yagpcc.truncate_log() IS NOT NULL AS t;
 t 
---
 t
(1 row)

DROP FUNCTION yagp_status_order(text);
DROP EXTENSION yagp_hooks_collector;
RESET yagpcc.enable;
RESET yagpcc.report_nested_queries;
RESET yagpcc.enable_utility;
