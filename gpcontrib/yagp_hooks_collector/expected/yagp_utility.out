CREATE EXTENSION yagp_hooks_collector;
CREATE OR REPLACE FUNCTION yagp_status_order(status text)
RETURNS integer
AS $$
BEGIN
    RETURN CASE status
        WHEN 'QUERY_STATUS_SUBMIT' THEN 1
        WHEN 'QUERY_STATUS_START' THEN 2
        WHEN 'QUERY_STATUS_END' THEN 3
        WHEN 'QUERY_STATUS_DONE' THEN 4
        ELSE 999
    END;
END;
$$ LANGUAGE plpgsql IMMUTABLE;
SET yagpcc.enable TO TRUE;
SET yagpcc.enable_utility TO TRUE;
SET yagpcc.report_nested_queries TO TRUE;
SET yagpcc.logging_mode to 'TBL';
CREATE TABLE test_table (a int, b text);
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'a' as the Apache Cloudberry data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
CREATE INDEX test_idx ON test_table(a);
ALTER TABLE test_table ADD COLUMN c int DEFAULT 1;
DROP TABLE test_table;
RESET yagpcc.logging_mode;
SELECT segid, query_text, query_status FROM yagpcc.log WHERE segid = -1 AND utility = true ORDER BY segid, ccnt, yagp_status_order(query_status) ASC;
 segid |                     query_text                     |    query_status     
-------+----------------------------------------------------+---------------------
    -1 |                                                    | QUERY_STATUS_DONE
    -1 | CREATE TABLE test_table (a int, b text);           | QUERY_STATUS_SUBMIT
    -1 | CREATE TABLE test_table (a int, b text);           | QUERY_STATUS_DONE
    -1 | CREATE INDEX test_idx ON test_table(a);            | QUERY_STATUS_SUBMIT
    -1 | CREATE INDEX test_idx ON test_table(a);            | QUERY_STATUS_DONE
    -1 | ALTER TABLE test_table ADD COLUMN c int DEFAULT 1; | QUERY_STATUS_SUBMIT
    -1 | ALTER TABLE test_table ADD COLUMN c int DEFAULT 1; | QUERY_STATUS_DONE
    -1 | DROP TABLE test_table;                             | QUERY_STATUS_SUBMIT
    -1 | DROP TABLE test_table;                             | QUERY_STATUS_DONE
    -1 | RESET yagpcc.logging_mode;                         | QUERY_STATUS_SUBMIT
(10 rows)

SELECT yagpcc.truncate_log() IS NOT NULL AS t;
 t 
---
(0 rows)

-- Partitioning
SET yagpcc.logging_mode to 'TBL';
CREATE TABLE pt_test (a int, b int)
DISTRIBUTED BY (a)
PARTITION BY RANGE (a)
(START (0) END (100) EVERY (50));
NOTICE:  CREATE TABLE will create partition "pt_test_1_prt_1" for table "pt_test"
NOTICE:  CREATE TABLE will create partition "pt_test_1_prt_2" for table "pt_test"
DROP TABLE pt_test;
RESET yagpcc.logging_mode;
SELECT segid, query_text, query_status FROM yagpcc.log WHERE segid = -1 AND utility = true ORDER BY segid, ccnt, yagp_status_order(query_status) ASC;
 segid |             query_text              |    query_status     
-------+-------------------------------------+---------------------
    -1 |                                     | QUERY_STATUS_DONE
    -1 | CREATE TABLE pt_test (a int, b int)+| QUERY_STATUS_SUBMIT
       | DISTRIBUTED BY (a)                 +| 
       | PARTITION BY RANGE (a)             +| 
       | (START (0) END (100) EVERY (50));   | 
    -1 | CREATE TABLE pt_test (a int, b int)+| QUERY_STATUS_SUBMIT
       | DISTRIBUTED BY (a)                 +| 
       | PARTITION BY RANGE (a)             +| 
       | (START (0) END (100) EVERY (50));   | 
    -1 | CREATE TABLE pt_test (a int, b int)+| QUERY_STATUS_SUBMIT
       | DISTRIBUTED BY (a)                 +| 
       | PARTITION BY RANGE (a)             +| 
       | (START (0) END (100) EVERY (50));   | 
    -1 | CREATE TABLE pt_test (a int, b int)+| QUERY_STATUS_DONE
       | DISTRIBUTED BY (a)                 +| 
       | PARTITION BY RANGE (a)             +| 
       | (START (0) END (100) EVERY (50));   | 
    -1 | CREATE TABLE pt_test (a int, b int)+| QUERY_STATUS_DONE
       | DISTRIBUTED BY (a)                 +| 
       | PARTITION BY RANGE (a)             +| 
       | (START (0) END (100) EVERY (50));   | 
    -1 | CREATE TABLE pt_test (a int, b int)+| QUERY_STATUS_DONE
       | DISTRIBUTED BY (a)                 +| 
       | PARTITION BY RANGE (a)             +| 
       | (START (0) END (100) EVERY (50));   | 
    -1 | DROP TABLE pt_test;                 | QUERY_STATUS_SUBMIT
    -1 | DROP TABLE pt_test;                 | QUERY_STATUS_DONE
    -1 | RESET yagpcc.logging_mode;          | QUERY_STATUS_SUBMIT
(10 rows)

SELECT yagpcc.truncate_log() IS NOT NULL AS t;
 t 
---
(0 rows)

-- Views and Functions
SET yagpcc.logging_mode to 'TBL';
CREATE VIEW test_view AS SELECT 1 AS a;
CREATE FUNCTION test_func(i int) RETURNS int AS $$ SELECT $1 + 1; $$ LANGUAGE SQL;
DROP VIEW test_view;
DROP FUNCTION test_func(int);
RESET yagpcc.logging_mode;
SELECT segid, query_text, query_status FROM yagpcc.log WHERE segid = -1 AND utility = true ORDER BY segid, ccnt, yagp_status_order(query_status) ASC;
 segid |                                     query_text                                     |    query_status     
-------+------------------------------------------------------------------------------------+---------------------
    -1 |                                                                                    | QUERY_STATUS_DONE
    -1 | CREATE VIEW test_view AS SELECT 1 AS a;                                            | QUERY_STATUS_SUBMIT
    -1 | CREATE VIEW test_view AS SELECT 1 AS a;                                            | QUERY_STATUS_DONE
    -1 | CREATE FUNCTION test_func(i int) RETURNS int AS $$ SELECT $1 + 1; $$ LANGUAGE SQL; | QUERY_STATUS_SUBMIT
    -1 | CREATE FUNCTION test_func(i int) RETURNS int AS $$ SELECT $1 + 1; $$ LANGUAGE SQL; | QUERY_STATUS_DONE
    -1 | DROP VIEW test_view;                                                               | QUERY_STATUS_SUBMIT
    -1 | DROP VIEW test_view;                                                               | QUERY_STATUS_DONE
    -1 | DROP FUNCTION test_func(int);                                                      | QUERY_STATUS_SUBMIT
    -1 | DROP FUNCTION test_func(int);                                                      | QUERY_STATUS_DONE
    -1 | RESET yagpcc.logging_mode;                                                         | QUERY_STATUS_SUBMIT
(10 rows)

SELECT yagpcc.truncate_log() IS NOT NULL AS t;
 t 
---
(0 rows)

-- Transaction Operations
SET yagpcc.logging_mode to 'TBL';
BEGIN;
SAVEPOINT sp1;
ROLLBACK TO sp1;
COMMIT;
BEGIN;
SAVEPOINT sp2;
ABORT;
BEGIN;
ROLLBACK;
RESET yagpcc.logging_mode;
SELECT segid, query_text, query_status FROM yagpcc.log WHERE segid = -1 AND utility = true ORDER BY segid, ccnt, yagp_status_order(query_status) ASC;
 segid |         query_text         |    query_status     
-------+----------------------------+---------------------
    -1 |                            | QUERY_STATUS_DONE
    -1 | BEGIN;                     | QUERY_STATUS_SUBMIT
    -1 | BEGIN;                     | QUERY_STATUS_DONE
    -1 | SAVEPOINT sp1;             | QUERY_STATUS_SUBMIT
    -1 | ROLLBACK TO sp1;           | QUERY_STATUS_SUBMIT
    -1 | ROLLBACK TO sp1;           | QUERY_STATUS_DONE
    -1 | COMMIT;                    | QUERY_STATUS_SUBMIT
    -1 | COMMIT;                    | QUERY_STATUS_DONE
    -1 | BEGIN;                     | QUERY_STATUS_SUBMIT
    -1 | BEGIN;                     | QUERY_STATUS_DONE
    -1 | SAVEPOINT sp2;             | QUERY_STATUS_SUBMIT
    -1 | ABORT;                     | QUERY_STATUS_SUBMIT
    -1 | ABORT;                     | QUERY_STATUS_DONE
    -1 | BEGIN;                     | QUERY_STATUS_SUBMIT
    -1 | BEGIN;                     | QUERY_STATUS_DONE
    -1 | ROLLBACK;                  | QUERY_STATUS_SUBMIT
    -1 | ROLLBACK;                  | QUERY_STATUS_DONE
    -1 | RESET yagpcc.logging_mode; | QUERY_STATUS_SUBMIT
(18 rows)

SELECT yagpcc.truncate_log() IS NOT NULL AS t;
 t 
---
(0 rows)

-- DML Operations
SET yagpcc.logging_mode to 'TBL';
CREATE TABLE dml_test (a int, b text);
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'a' as the Apache Cloudberry data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
INSERT INTO dml_test VALUES (1, 'test');
UPDATE dml_test SET b = 'updated' WHERE a = 1;
DELETE FROM dml_test WHERE a = 1;
DROP TABLE dml_test;
RESET yagpcc.logging_mode;
SELECT segid, query_text, query_status FROM yagpcc.log WHERE segid = -1 AND utility = true ORDER BY segid, ccnt, yagp_status_order(query_status) ASC;
 segid |               query_text               |    query_status     
-------+----------------------------------------+---------------------
    -1 |                                        | QUERY_STATUS_DONE
    -1 | CREATE TABLE dml_test (a int, b text); | QUERY_STATUS_SUBMIT
    -1 | CREATE TABLE dml_test (a int, b text); | QUERY_STATUS_DONE
    -1 | DROP TABLE dml_test;                   | QUERY_STATUS_SUBMIT
    -1 | DROP TABLE dml_test;                   | QUERY_STATUS_DONE
    -1 | RESET yagpcc.logging_mode;             | QUERY_STATUS_SUBMIT
(6 rows)

SELECT yagpcc.truncate_log() IS NOT NULL AS t;
 t 
---
(0 rows)

-- COPY Operations
SET yagpcc.logging_mode to 'TBL';
CREATE TABLE copy_test (a int);
NOTICE:  Table doesn't have 'DISTRIBUTED BY' clause -- Using column named 'a' as the Apache Cloudberry data distribution key for this table.
HINT:  The 'DISTRIBUTED BY' clause determines the distribution of data. Make sure column(s) chosen are the optimal data distribution key to minimize skew.
COPY (SELECT 1) TO STDOUT;
1
DROP TABLE copy_test;
RESET yagpcc.logging_mode;
SELECT segid, query_text, query_status FROM yagpcc.log WHERE segid = -1 AND utility = true ORDER BY segid, ccnt, yagp_status_order(query_status) ASC;
 segid |           query_text            |    query_status     
-------+---------------------------------+---------------------
    -1 |                                 | QUERY_STATUS_DONE
    -1 | CREATE TABLE copy_test (a int); | QUERY_STATUS_SUBMIT
    -1 | CREATE TABLE copy_test (a int); | QUERY_STATUS_DONE
    -1 | COPY (SELECT 1) TO STDOUT;      | QUERY_STATUS_SUBMIT
    -1 | COPY (SELECT 1) TO STDOUT;      | QUERY_STATUS_DONE
    -1 | DROP TABLE copy_test;           | QUERY_STATUS_SUBMIT
    -1 | DROP TABLE copy_test;           | QUERY_STATUS_DONE
    -1 | RESET yagpcc.logging_mode;      | QUERY_STATUS_SUBMIT
(8 rows)

SELECT yagpcc.truncate_log() IS NOT NULL AS t;
 t 
---
(0 rows)

-- Prepared Statements and error during execute
SET yagpcc.logging_mode to 'TBL';
PREPARE test_prep(int) AS SELECT $1/0 AS value;
EXECUTE test_prep(0::int);
ERROR:  division by zero
DEALLOCATE test_prep;
RESET yagpcc.logging_mode;
SELECT segid, query_text, query_status FROM yagpcc.log WHERE segid = -1 AND utility = true ORDER BY segid, ccnt, yagp_status_order(query_status) ASC;
 segid |                   query_text                    |    query_status     
-------+-------------------------------------------------+---------------------
    -1 |                                                 | QUERY_STATUS_DONE
    -1 | PREPARE test_prep(int) AS SELECT $1/0 AS value; | QUERY_STATUS_SUBMIT
    -1 | PREPARE test_prep(int) AS SELECT $1/0 AS value; | QUERY_STATUS_DONE
    -1 | EXECUTE test_prep(0::int);                      | QUERY_STATUS_SUBMIT
    -1 | EXECUTE test_prep(0::int);                      | QUERY_STATUS_ERROR
    -1 | DEALLOCATE test_prep;                           | QUERY_STATUS_SUBMIT
    -1 | DEALLOCATE test_prep;                           | QUERY_STATUS_DONE
    -1 | RESET yagpcc.logging_mode;                      | QUERY_STATUS_SUBMIT
(8 rows)

SELECT yagpcc.truncate_log() IS NOT NULL AS t;
 t 
---
(0 rows)

-- GUC Settings
SET yagpcc.logging_mode to 'TBL';
SET yagpcc.report_nested_queries TO FALSE;
RESET yagpcc.report_nested_queries;
RESET yagpcc.logging_mode;
SELECT segid, query_text, query_status FROM yagpcc.log WHERE segid = -1 AND utility = true ORDER BY segid, ccnt, yagp_status_order(query_status) ASC;
 segid |                 query_text                 |    query_status     
-------+--------------------------------------------+---------------------
    -1 |                                            | QUERY_STATUS_DONE
    -1 | SET yagpcc.report_nested_queries TO FALSE; | QUERY_STATUS_SUBMIT
    -1 | SET yagpcc.report_nested_queries TO FALSE; | QUERY_STATUS_DONE
    -1 | RESET yagpcc.report_nested_queries;        | QUERY_STATUS_SUBMIT
    -1 | RESET yagpcc.report_nested_queries;        | QUERY_STATUS_DONE
    -1 | RESET yagpcc.logging_mode;                 | QUERY_STATUS_SUBMIT
(6 rows)

SELECT yagpcc.truncate_log() IS NOT NULL AS t;
 t 
---
(0 rows)

DROP FUNCTION yagp_status_order(text);
DROP EXTENSION yagp_hooks_collector;
RESET yagpcc.enable;
RESET yagpcc.report_nested_queries;
RESET yagpcc.enable_utility;
